# 内存检测

 BIOS 0X15 0xe820

Address Range Descriptor Structure ARDS

- 属于系统调用，是BIOS用来检测不同物理机的内存分配从而选择区域来放入操作系统的代码

| 字节偏移量 | 属性名称 | 名称 |
| ------ | ------ | ------ |
| 0  | BaseAddrlow | 基地址的低 32 位  |
| 4  | BaseAddrHigh | 基地址的高 32 位  |
| 8 | LengthLow | 内存长度的低32位，以字节为单位 |
| 12 | LengthHigh | 内存长度的高32位，以字节为单位 |
| 16 | Type | 存储类型 |

## Type字段

| Type值 | 名称 | 描述 |
| ------ | ------ | ------ |
| 1 | AddressRangMemory | 可以被操作系统使用的部分 |
| 2 | AddressRangeReserved | 内存使用中或者被系统保留，操作系统不可以使用 |
| 其他 | 未定义 | 未定义，将来会使用，目前保留，被操作系统任务与2相同 |

## 调用前寄存器或状态位设置

|寄存器或状态为 | 参数用途 |
| ------ | ------ |
|EAX | 子功能号：  Eax寄存器 用来指定子功能号，此处输入为  0xE820|
| EBX | 内存信息需要按类型分多次返回，由于每执行一次中断都只返回一种类型内存的ARDS 结构所以要记录下一个待返回内存ARDS, 在下一次中段调用是通过此值告诉 BIOS 该返回哪个ARDS,这就是后续值的作用。第一次调用是一定要赋值为0，EBX的具体值不需要更换主，在每次中断后，BIOS 都会更新这个值|
| ES:DI | ARDS 缓冲区： BIOS 将获取的内存信息写存入此寄存器执行的内存，每次都以 ARDS 格式返回 |
| ECX | ARDS 结构的字节大小： 用来指示 BIOS 写入的字节数。调用者与BIOS都支持的大小是 20 字节 |
| EDX| 检测ARDS 缓冲区的的信息，固定为 0x534d4150 |

## 返回值

| 寄存器或状态位 | 参数解释 |
| ------ | ------ |
| CF位 | 若 CF 位为 0 表示 0x15 类型的系统调用未出错， CF 为 1 ,表示系统调用出现问题 |
| EAX | 固定储存 0x534d4150 是 SMAP 的ASCII值|
| ES:DI | ARDS缓冲区地址 |
| ECX | BIOS 写入到ES:DI 所指向的 ARDS 结构的字节数， BIOS最小写入 20 字节 |
| EBX | 后续值： 下一个 ARDS 的位置，每次中断结束后都会更新此值，BIOS可以找到下一个待返回的 ARDS 结构，在 CF 为 0 的情况下，若返回 EBX 为 0 的情况下，表示这为最后一个 ARDS 结构|

## 注解

- 子功能号

  - 子功能号可以用来指定内存检测的方式，可以对内存有更全面的了解比如可以检测数据线的连通性、内存的速度是否符合规格、内存容量大小是否正确等等

- ARDS数据结构
  
  - ARDS（通过系统调用来获取）以不同类型的内存块为单位

    - 内存映射和管理：通过 ARDS，操作系统可以了解整个系统的内存地址范围，以便对物理内存进行映射和管理。操作系统可以将物理内存划分为多个可用区域，按需进行分配，同时还可以对地址空间进行保护和限制。

    - 内存检测：ARDS 中包含了系统中可用的物理内存地址范围，操作系统可以利用这些信息，进行内存检测和错误修复。例如，操作系统可以比较 ARDS 和内存检测器输出结果，以便找到不匹配的地方，识别并隔离出存在问题的内存区域，从而提高了系统的稳定性和可靠性。

    - 系统启动：在操作系统启动时，ARDS 也会被使用。操作系统会寻找桌面系统内核和驱动程序等重要组件所需的内存地址范围，以确保系统可以顺利启动。
- ARDS与BIOS的关系

  - ARDS（Address Range Descriptor Structure）是由BIOS（Basic Input/Output System）提供的内存信息结构。在计算机启动时，BIOS 会扫描系统中可用的内存，并将这些数据存储在 ARDS 缓冲区中。当操作系统启动时，它会读取这个 ARDS 缓冲区，解析里面的数据，用于生成内存映射，管理内存资源以及为应用程序提供可用的内存。这样，操作系统就能得到详细的内存信息，从而能够在运行的时候进行内存管理。可以说，ARDS 与 BIOS 的关系紧密相关。BIOS 是系统启动过程中最早被执行的软件层级，而 ARDS 是 BIOS 提供给操作系统的一种机制，帮助操作系统了解计算机系统的内存结构。因此，系统 BIOS负责在计算机启动时创建 ARDS 数据结构，当操作系统启动时，它就能从 ARDS 中读取内存信息。总的来说，ARDS 是由 BIOS 提供的内存结构，用于提供计算机系统中可用内存的信息。操作系统可以通过访问 ARDS 缓冲区来读取内存信息，这有助于操作系统进行内存管理和资源分配，保证系统的正常运行。

## 代码思路

分为两个部分，一个是寄存器初始化部分，一个是.next，在 next 部分需要设置子功能号以及遍历的所有的ards数据结构，

```s
detect_memory:
   ;寄存器赋值
   xor ebx ,ebx;将ebx赋0
   ;确定缓冲区的大小
   mov ax,0;
   mov es,ax
   mov edi,ards_buffer;

   mov edx ,0x534d4150;固定签名

   .next
      ;子功能号
      mov eax,0xe820
      ;结构体的大小（字节）
      mov ecx ,20;设置字节大小
      ;系统调用
      int 0x15;BIOS 的系统调用
      ;检测标志位
      jc error;条件跳转
      
      ;没问题的话就接着遍历 di ARDS 缓冲区
      add di ,cx;cx存的是20，特殊的寄存器需要间接存

      inc word [ards_count];自增ards的数量

      cmp ebx,0;比较后续值，判断还有没有ards
      jnz .next
      
      ;检测结束
      mov si,detecting
      call print
      xchg bx,bx

```
